package com.viettelpost.core.services.daos.TikTokShop;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.viettelpost.core.base.BaseDAO2;
import com.viettelpost.core.response.OrderDetailResponse;
import com.viettelpost.core.response.PriceResponse;
import com.viettelpost.core.services.domains.*;
import com.viettelpost.core.services.form.AddressInputForm;
import com.viettelpost.core.utils.CommonUtils;
import com.viettelpost.core.utils.Constants;
import com.viettelpost.core.utils.Utils;
import lombok.extern.slf4j.Slf4j;
import oracle.jdbc.internal.OracleTypes;
import org.hibernate.Query;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.NativeQuery;
import org.hibernate.transform.Transformers;
import org.hibernate.type.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.env.Environment;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.stereotype.Service;

import java.sql.*;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.Date;

@Service
@Slf4j
public class TTS_DAO extends BaseDAO2 {

    @Value("${name.project}")
    String nameProject;

    @Value("${server.port}")
    String serverPort;

    @Value("${error.text.kafka}")
    String errorTextKafka;

    @Value("${error.text.oracle}")
    String errorTextOracle;

    final String PREFIX = "ERP_CUS.";

    @Autowired
    private MongoTemplate _template;

    ObjectMapper mapper = new ObjectMapper()
            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)
            .configure(DeserializationFeature.FAIL_ON_IGNORED_PROPERTIES, false);

    public int insertSpecialPrice(Connection connection, List<PriceResponse> _lPrice, String orderNumber) throws SQLException {
        if (!Utils.isNullOrEmpty(_lPrice)) {
            try {
                for (PriceResponse price : _lPrice) {
                    List params = Arrays.asList(orderNumber, price.getMaDV(), price.getGia());
                    int[] outs = new int[]{};
                    try (CallableStatement statement = connection.prepareCall(buildSQL(PREFIX + "CUS_INSERT.CUS_SPECIAL_INSERT", params, outs))) {
                        executeStatement(statement, params, outs);
                    }
                }
                return 1;
            } catch (Exception e) {
                log.error(e.getMessage(), e);
            } finally {
                connection.commit();
            }
        }
        return 0;
    }

    public List<AddressData> getAllSortCode() throws Exception {
        Session session = null;
        Transaction transaction = null;
        try {
            session = sessionFactory.openSession();
            try {
                Query query = session.createSQLQuery("SELECT 'VN' address_l0,A.NAME address_l1,B.NAME address_l2,C.NAME address_l3,'' address_l4, '' postcode ,\n" +
                                "(SELECT MA_TTKT FROM VTP.DM_TTKT_TINH WHERE MA_TINH = A.VALUE AND ROWNUM = 1) || '-' || A.VALUE || '-' || NVL((SELECT MA_BUUCUC FROM VTP.DM_CHIA \n" +
                                "WHERE ID_CHIA = (SELECT ID_PHUONGXA FROM VTP.DM_PHUONGXA WHERE MA_PHUONGXA = C.VALUE) AND ROWNUM = 1),\n" +
                                "(SELECT MA_BUUCUC FROM VTP.DM_CHIA WHERE MA_TINH = A.VALUE \n" +
                                "AND ID_QUANHUYEN = (SELECT ID_QUANHUYEN FROM VTP.DM_QUANHUYEN WHERE MA_QUANHUYEN = B.DESCRIPTION) AND ROWNUM = 1))  sort_code, '' site_code \n" +
                                "FROM ERP_CUS.CUS_PROVINCE A,\n" +
                                " ERP_CUS.CUS_DISTRICT B, ERP_CUS.CUS_WARDS C \n" +
                                "WHERE A.PROVINCE_ID = B.PROVINCE_ID AND B.DISTRICT_ID = C.DISTRICT_ID \n" +
                                "AND A.ISACTIVE = 'Y' AND B.ISACTIVE = 'Y' AND C.ISACTIVE = 'Y'\n" +
                                "\n")
                        .addScalar("address_l0", new StringType())
                        .addScalar("address_l1", new StringType())
                        .addScalar("address_l2", new StringType())
                        .addScalar("address_l3", new StringType())
                        .addScalar("address_l4", new StringType())
                        .addScalar("postcode", new StringType())
                        .addScalar("sort_code", new StringType())
                        .addScalar("site_code", new StringType())
                        .setResultTransformer(Transformers.aliasToBean(AddressData.class));

                return query.list();
            } catch (Exception ex) {
                log.error(ex.getLocalizedMessage(), ex);
            }
        } catch (Exception ex) {
            CommonUtils.writeErrorLogTask((new ErrorLogData(new Date(), nameProject, serverPort, Constants.errorSystem, errorTextOracle + ex.getLocalizedMessage(), ex.toString())).toString(), new Date());
            log.error(ex.getLocalizedMessage(), ex);
        } finally {
            commit(session, transaction);
        }
        return null;
    }

    public int createOrderTikTok(OrderInfo orderForm) throws Exception {
        List params = new ArrayList<>();
        params.add(orderForm.getPartnerId());
        params.add(orderForm.getUserId());
        params.add(orderForm.getGroupAddressId());
        params.add(orderForm.getOrderNumber());
        params.add(orderForm.getOrderReference());
        params.add(orderForm.getOrderDeliveryDate());

        //sender
        params.add(Utils.safeTrim(orderForm.getSenderFullName()));
        params.add(Utils.safeTrim(orderForm.getSenderAddress()));
        params.add(orderForm.getSenderPhone());
        params.add(orderForm.getSenderEmail());
        params.add(orderForm.getSenderWards());
        params.add(orderForm.getSenderDistrict());
        params.add(orderForm.getSenderProvince());
        params.add(orderForm.getSenderLatitude());
        params.add(orderForm.getSenderLongtitude());

        //receiver
        params.add(Utils.safeTrim(orderForm.getReceiverFullName()));
        params.add(Utils.safeTrim(orderForm.getReceiverAddress()));
        params.add(orderForm.getReceiverPhone());
        params.add(orderForm.getReceiverEmail());
        params.add(orderForm.getReceiverWards());
        params.add(orderForm.getReceiverDistrict());
        params.add(orderForm.getReceiverProvince());
        params.add(orderForm.getReceiverLatitude());
        params.add(orderForm.getReceiverLongtitude());

        //product
        params.add(orderForm.getProductName());
        params.add(orderForm.getProductDescription());
        params.add(orderForm.getProductQuantity());
        params.add(orderForm.getProductPrice());
        params.add(orderForm.getProductWeight());
        params.add(orderForm.getProductType());

        params.add(orderForm.getProductLength());
        params.add(orderForm.getProductWidth());
        params.add(orderForm.getProductHeight());
        params.add(orderForm.getProductExchangeWeight());

        //order
        params.add(orderForm.getOrderPayment());
        params.add(orderForm.getOrderService());
        params.add(orderForm.getOrderServiceAdd());
        params.add(orderForm.getOrderVoucher());
        params.add(orderForm.getOrderNote());
        params.add(orderForm.getMoneyCollection());
        params.add(orderForm.getMoneyTotalFee());
        params.add(orderForm.getMoneyFeeCod());
        params.add(orderForm.getMoneyFeeVas());
        params.add(orderForm.getMoneyFeeInsurance());
        params.add(orderForm.getMoneyFee());
        params.add(orderForm.getMoneyFeeOther());
        params.add(orderForm.getTotalVat());
        params.add(orderForm.getMoneyTotal());
        params.add(orderForm.getOrderType());
        params.add(orderForm.getSource());
        params.add(orderForm.getType());
        params.add(orderForm.getExtraMoney());
        params.add(0L);

        try (Connection conn = dataSource.getConnection()) {
            try {
                int[] outs = new int[]{OracleTypes.CURSOR};
                try (CallableStatement statement = conn.prepareCall(buildSQL("CUS_ECOMMERCE_NEW.CREATE_ORDER_REFERENCE", params, outs))) {
                    executeStatement(statement, params, outs);
                } catch (Exception ex) {
                    if (ex.getLocalizedMessage().contains("unique constraint") || ex.getLocalizedMessage().contains("CUS_ORDER_PK")) {
                        return 2;
                    }
                    log.error(ex.getLocalizedMessage() + " " + orderForm.getOrderNumber(), ex);
                    return 0;
                }
                insertReturnOptions(conn, orderForm.getOrderNumber(), orderForm.getReturnAddress());
                insertOrderInfoTikTok(conn, orderForm.getProviderOrderId(), orderForm.getPackageId(), orderForm.getOrderReference(), orderForm.getOrderNumber(), orderForm.getPartnerId(), orderForm.getUserId());
                insertOrderItem(conn, orderForm.getOrderNumber(), orderForm.getListItem());
                insertOrderOptions(conn, orderForm.getOrderNumber(), orderForm.getDeliveryCode());
                if (!Utils.isNullOrEmpty(orderForm.getOrderNumber()) && !Utils.isNullOrEmpty(orderForm.getListPrice())) {
                    insertSpecialPrice(conn, orderForm.getListPrice(), orderForm.getOrderNumber());
                }
                return 1;
            } catch (Exception ex) {
                CommonUtils.writeErrorLogTask((new ErrorLogData(new Date(), nameProject, serverPort, Constants.errorSystem, errorTextOracle + ex.getLocalizedMessage(), ex.toString())).toString(), new Date());
                log.error(ex.getLocalizedMessage() + " " + orderForm.getOrderNumber(), ex);
            }
            return 0;
        }
    }

    public void insertReturnOptions(Connection connection, String orderNumber, AddressInputForm addressInputForm) throws Exception {

        try {
            try (PreparedStatement preparedStatement = connection.prepareStatement("delete ERP_CUS.CUS_ORDER_OPTION_RETURN where order_number = ?")) {
                preparedStatement.setString(1, "orderNumber");
                preparedStatement.executeUpdate();
            }
            if (addressInputForm != null && addressInputForm.isRequired()) {
                String sql = "insert into  ERP_CUS.CUS_ORDER_OPTION_RETURN(order_number, code, option_value, option_type, create_date) values(?, ?, ?, 130, sysdate)";
                try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
                    preparedStatement.setString(1, orderNumber);
                    preparedStatement.setInt(2, 10);
                    preparedStatement.setString(3, addressInputForm.getProvinceId().toString());
                    preparedStatement.executeUpdate();
                }
                try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
                    preparedStatement.setString(1, orderNumber);
                    preparedStatement.setInt(2, 11);
                    preparedStatement.setString(3, addressInputForm.getDistrictId().toString());
                    preparedStatement.executeUpdate();
                }
                try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
                    preparedStatement.setString(1, orderNumber);
                    preparedStatement.setInt(2, 12);
                    preparedStatement.setString(3, addressInputForm.getWardsId().toString());
                    preparedStatement.executeUpdate();
                }
                if (!Utils.isNullOrEmpty(addressInputForm.getAddress())) {
                    try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
                        preparedStatement.setString(1, orderNumber);
                        preparedStatement.setInt(2, 13);
                        preparedStatement.setString(3, addressInputForm.getAddress());
                        preparedStatement.executeUpdate();
                    }
                }
                if (!Utils.isNullOrEmpty(addressInputForm.getName())) {
                    try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
                        preparedStatement.setString(1, orderNumber);
                        preparedStatement.setInt(2, 14);
                        preparedStatement.setString(3, addressInputForm.getName());
                        preparedStatement.executeUpdate();
                    }
                }
                if (!Utils.isNullOrEmpty(addressInputForm.getPhone())) {
                    try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
                        preparedStatement.setString(1, orderNumber);
                        preparedStatement.setInt(2, 15);
                        preparedStatement.setString(3, addressInputForm.getPhone());
                        preparedStatement.executeUpdate();
                    }
                }
            }
        } catch (Exception ex) {
            CommonUtils.writeErrorLogTask((new ErrorLogData(new Date(), nameProject, serverPort, Constants.errorSystem, errorTextOracle + ex.getLocalizedMessage(), ex.toString())).toString(), new Date());
            log.error(ex.getMessage(), ex);
        }
    }

    public void insertOrderItem(Connection connection, String orderNumber, List<OrderItem> listItem) throws SQLException {
        if (listItem != null) {
            for (OrderItem item : listItem) {
                try {
                    int[] outs = new int[]{};
                    List params = Arrays.asList(orderNumber, item.getProductName(), item.getProductPrice(), item.getProductWeight(), item.getProductQuantity());
                    try (CallableStatement statement = connection.prepareCall(buildSQL(PREFIX + "CUS_INSERT.INSERT_ORDER_DETAIL", params, outs))) {
                        executeStatement(statement, params, outs);
                    }
                } catch (Exception e) {
                    log.error(e.getMessage(), e);
                }
            }
        }
    }

    public void insertOrderOptions(Connection connection, String orderNumber, int code) throws SQLException {

        try {
            int[] outs = new int[]{};
            List params = Arrays.asList(orderNumber, code);
            try (CallableStatement statement = connection.prepareCall(buildSQL(PREFIX + "CUS_INSERT.INSERT_ORDER_OPTIONS", params, outs))) {
                executeStatement(statement, params, outs);
            }
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

    public void insertOrderInfoTikTok(Connection connection, String providerOrderId, String packageId, String trackingNo, String
            orderNumber, Long partner_id, Long cusId) throws Exception {
        try {
            try (PreparedStatement statement = connection.prepareStatement("INSERT INTO VTP.WAYBILL_CUS_INFO (PROVIDER_ORDER_ID,PACKAGE_ID,TRACKING_NO,ORDER_NUMBER,PARTNER_ID,CUS_ID) VALUES(?,?,?,?,?,?)")) {
                statement.setString(1, providerOrderId);
                statement.setString(2, packageId);
                statement.setString(3, trackingNo);
                statement.setString(4, orderNumber);
                statement.setLong(5, partner_id);
                statement.setLong(6, cusId);
                statement.executeUpdate();
            }
        } catch (Exception ex) {
            CommonUtils.writeErrorLogTask((new ErrorLogData(new Date(), nameProject, serverPort, Constants.errorSystem, errorTextOracle + ex.getLocalizedMessage(), ex.toString())).toString(), new Date());
            log.error(ex.getMessage(), ex);
        }
    }

    public List<TikTokStatusData> getDetailOrderNumber(String orderNumber) throws Exception {
        Session session = null;
        try {
            session = sessionFactory.openSession();
            try {
                String sql = "SELECT TRACKING_ID, ORDER_STATUS,ORDER_POST_ID," +
                        "case when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1021' then 'R503'\n" +
                        "    when ORDER_STATUS = 503 or ORDER_STATUS = 516 or ORDER_STATUS = 517 then 'R800'\n" +
                        "\twhen VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1022' then 'R114'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1023' then 'R119'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1024' then 'R112'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1025' then 'R500'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1026' then 'R109'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1027' then 'R114'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '1028' then 'R129'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50520' then 'R417'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50521' then 'R417'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50522' then 'R417'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50523' then 'R424'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50524' then 'R418'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50525' then 'R102'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50526' then 'R408'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50527' then 'R103'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50528' then 'R104'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50529' then 'R115'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50530' then 'R400'\n" +
                        "    when VTP.GET_BILL_FAILURE_REASON(A.ORDER_NUMBER,ORDER_STATUS) = '50532' then 'R403'\n" +
                        "    when ORDER_STATUS = 506 THEN 'R425' " +
                        "    when ORDER_STATUS = 507 THEN 'R123' " +
                        "    when ORDER_STATUS = 509 THEN 'R103' " +
                        "    else '' end as reason_code, " +
                        "                             ORDER_NUMBER tracking_no,  " +
                        "                            'UTC+7'  TIME_ZONE,  " +
                        "                             ORDER_REFERENCE ," +
                        "                             (select PROVIDER_ORDER_ID from WAYBILL_CUS_INFO where ORDER_NUMBER = A.ORDER_NUMBER)    provider_order_id," +
                        "                             TO_CHAR (A.ORDER_STATUSDATE, 'YYYY-MM-DD HH24:MI:SS') AS OPERATE_TIME,  " +
                        "                             CASE WHEN ORDER_STATUS = 102 THEN 'pickup_failure'" +
                        "     WHEN ORDER_STATUS = 107 THEN 'pkg_cancelled'" +
                        "     WHEN ORDER_STATUS = 103 OR ORDER_STATUS = 104 THEN 'pickup_start'" +
                        "     WHEN ORDER_STATUS = 105 OR ORDER_STATUS = 200 THEN 'pickup_success'" +
                        "     WHEN ORDER_STATUS = 202 THEN 'unreachable_returned' " +
                        "     WHEN ORDER_STATUS = 300 THEN\n" +
                        "                               NVL((SELECT 'pickup_station_out'\n" +
                        "                                           FROM ERP_CUS.CUS_ORDER_STATUS_HIS\n" +
                        "                                           WHERE ORDER_NUMBER = A.ORDER_NUMBER\n" +
                        "                                             AND ORDER_STATUS = 200 AND ORDER_POST_ID = A.ORDER_POST_ID), 'sc_outbound')" +

                        "     WHEN ORDER_STATUS = 400 OR ORDER_STATUS = 310 OR ORDER_STATUS = 320 THEN 'sc_inbound'" +
                        "     WHEN ORDER_STATUS = 410 THEN 'sc_outbound'" +
                        "     WHEN ORDER_STATUS = 500 THEN 'delivery_start'" +
                        "     WHEN ORDER_STATUS = 501 THEN 'signed_personally'" +
                        "     WHEN ORDER_STATUS = 505 OR ORDER_STATUS = 506 OR ORDER_STATUS = 507 OR ORDER_STATUS = 508 THEN 'sign_failure'" +
                        "     WHEN ORDER_STATUS = 502 THEN 'unreachable_returning'" +
                        "     WHEN ORDER_STATUS = 504 THEN 'unreachable_returned'" +
                        "     WHEN ORDER_STATUS = 516 THEN 'pkg_lost'" +
                        "     WHEN ORDER_STATUS = 503 THEN 'pkg_scrap'" +
                        "     WHEN ORDER_STATUS = 517 THEN 'pkg_damaged'" +
                        "     WHEN ORDER_STATUS = 515 OR ORDER_STATUS = 550 THEN 'sign_failure' " +
                        "     WHEN ORDER_STATUS = 509 THEN 'delivery_exception' " +
                        "     ELSE '' " +
                        "     END AS  ACTION_CODE,  " +
                        "                             (SELECT NAME AS STATUS_NAME  " +
                        "                                FROM ERP_CUS.CUS_CATEGORIES  " +
                        "                               WHERE CODE = A.ORDER_STATUS AND TYPE <> 116 AND ROWNUM = 1)  " +
                        "                                AS STATUS_NAME,  " +
                        "                             ERP_CUS.VTP_PUSH_TRACKING.GET_NOTE(A.ORDER_NUMBER, A.ORDER_STATUS, A.ORDER_STATUSDATE, A.NOTE) OPERATION_DESC,  " +
                        "                             (SELECT PRODUCT_WEIGHT  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS WEIGHT,  " +
                        "                                (SELECT PRODUCT_HEIGHT  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS HEIGHT,  " +
                        "                                (SELECT PRODUCT_WIDTH " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS WIDTH,  " +
                        "                                (SELECT PRODUCT_LENGTH " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS LENGTH,  " +
                        "                             (SELECT MONEY_COLLECTION  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_COLLECTION, " +
                        "                             (SELECT THU_HO " +
                        "                                FROM  VTP.PHIEU_GUI " +
                        "                                WHERE MA_PHIEUGUI = A.ORDER_NUMBER) " +
                        "                                 AS MONEY_COLLECTION_ORIGIN,  " +
                        "                             (SELECT MONEY_TOTALFEE  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS SHIPPING_FEE,  " +
                        "                             (SELECT MONEY_FEECOD  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_FEECOD,  " +
                        "                             (SELECT MONEY_FEEVAS  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_FEEVAS,  " +
                        "                             (SELECT MONEY_FEEINSURRANCE  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_FEEINSURRANCE,  " +
                        "                             (SELECT MONEY_FEE  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_FEE,  " +
                        "                             (SELECT MONEY_FEEOTHER  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_FEEOTHER,  " +
                        "                             (SELECT MONEY_TOTALVAT  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS MONEY_TOTALVAT,  " +
                        "                             (SELECT MONEY_TOTAL  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER)  " +
                        "                                AS SERVICE_FEE,  " +
                        "                                'VN' ADDRESS_L0, " +
                        "                                    (SELECT (SELECT NAME  " +
                        "                                            FROM ERP_CUS.CUS_PROVINCE  " +
                        "                                         WHERE VALUE = TO_CHAR(X.MA_TINH)) " +
                        "                                FROM VTP.DM_BUUCUC X, VTP.DM_BUUCUCQUANLYVIEW Y  " +
                        "                               WHERE ID_BUUCUC = A.ORDER_POST_ID AND X.MA_BUUCUC= Y.BUUCUC) ADDRESS_L1, " +
                        "                                    (SELECT  " +
                        "                                      (SELECT TEN_PHUONGXA FROM VTP.DM_PHUONGXA WHERE MA_PHUONGXA = TO_CHAR(PHUONGXA) AND ROWNUM = 1)  " +
                        "                                FROM VTP.DM_BUUCUC X, VTP.DM_BUUCUCQUANLYVIEW Y  " +
                        "                               WHERE ID_BUUCUC = A.ORDER_POST_ID AND X.MA_BUUCUC= Y.BUUCUC)  ADDRESS_L2, " +
                        "                               (SELECT (SELECT TEN_QUANHUYEN FROM DM_QUANHUYEN  " +
                        "                                WHERE MA_QUANHUYEN = (SELECT MA_QUANHUYEN FROM DM_QUANHUYEN_BUUCUC WHERE MA_BUUCUC = X.MA_BUUCUC AND ROWNUM = 1)) FROM VTP.DM_BUUCUC X  " +
                        "                                    WHERE ID_BUUCUC = A.ORDER_POST_ID) ADDRESS_L3, " +
                        "                               (SELECT LATITUDE FROM VTP.DM_BUUCUC X, VTP.DM_BUUCUCQUANLYVIEW Y  " +
                        "                               WHERE  X.MA_BUUCUC= Y.BUUCUC AND X.ID_BUUCUC  = A.ORDER_POST_ID " +
                        "                                ) LATITUDE, " +
                        "                               (SELECT LONGITUDE FROM VTP.DM_BUUCUC X, VTP.DM_BUUCUCQUANLYVIEW Y  " +
                        "                               WHERE  X.MA_BUUCUC= Y.BUUCUC AND X.ID_BUUCUC  = A.ORDER_POST_ID " +
                        "                                ) LONGITUDE, " +
                        "                                (SELECT CAP_BUUCUC FROM VTP.DM_BUUCUC X WHERE X.ID_BUUCUC = A.ORDER_POST_ID) SITE_TYPE, " +
                        "                                'VND' CURRENCY, " +
                        "                             (SELECT ERP_CUS.GET_KPI (VTP.GET_TINH (MA_BUUCUC_GOC),  " +
                        "                                 MA_VUNG_PHAT,  " +
                        "                                 MA_DV_VIETTEL)  " +
                        "                                FROM VTP.PHIEU_GUI  " +
                        "                               WHERE MA_PHIEUGUI = A.ORDER_NUMBER)  " +
                        "                                EXPECTED_DELIVERY,  " +
                        "                               (SELECT ORDER_SERVICE  " +
                        "                                FROM  ERP_CUS.CUS_ORDER  " +
                        "                               WHERE ORDER_NUMBER = A.ORDER_NUMBER) ORDER_SERVICE  " +
                        "                               , (SELECT TO_CHAR(TO_DATE(NGAY_GUI_BP) + 1  +" +
                        "                                NVL((SELECT TG_CHITIEU FROM VTP.KPI_HT WHERE TINH_DI = VTP.GET_TINH (MA_BUUCUC_GOC)  " +
                        "                                AND TINH_DEN = MA_VUNG_PHAT AND NHOM_DV LIKE '%,'||MA_DV_VIETTEL||'%' AND ROWNUM = 1), 0)/24, 'DD/MM/YYYY HH24:MI:SS') FROM VTP.PHIEU_GUI  " +
                        "                               WHERE MA_PHIEUGUI = A.ORDER_NUMBER) EXPECTED_DELIVERY_DATE " +
                        "                               , (SELECT ORDER_PAYMENT " +
                        "                                        FROM ERP_CUS.CUS_ORDER " +
                        "                                        WHERE ORDER_NUMBER = A.ORDER_NUMBER) " +
                        "                                        AS ORDER_PAYMENT " +
                        "                               , NVL((SELECT V_VALUE FROM ERP_WALLET.VP_VOUCHER_USED WHERE STATUS >=0 AND ORDER_NUMBER = A.ORDER_NUMBER), 0) VOUCHER_VALUE " +
                        "                               , (SELECT FIRSTNAME ||' '||LASTNAME FROM VTP.SUSERS WHERE USERID = A.ORDER_EMPLOYER AND A.ORDER_EMPLOYER IS NOT NULL AND ORDER_EMPLOYER > 0) NAME " +
                        "                               , (SELECT TELEPHONE FROM VTP.SUSERS WHERE USERID = A.ORDER_EMPLOYER AND A.ORDER_EMPLOYER IS NOT NULL AND ORDER_EMPLOYER > 0) PHONE " +
                        "                               , NVL((SELECT 1 FROM ERP_CUS.CUS_ORDER_STATUS_HIS WHERE ORDER_NUMBER = A.ORDER_NUMBER AND ORDER_STATUS = 502 AND ORDER_STATUSDATE <= A.ORDER_STATUSDATE AND ROWNUM = 1), 0) AS ISRETURNING" +
                        "                               , (SELECT MA_BUUCUC || '-' || TEN_BUUCUC FROM DM_BUUCUC WHERE ID_BUUCUC = A.ORDER_POST_ID) AS SITE_NAME" +
                        "                                         FROM ERP_CUS.CUS_ORDER_STATUS_HIS A  " +
                        "                                         WHERE ORDER_NUMBER = ? " +
                        "                                         AND A.ORDER_STATUS != 202  " +
                        "   AND  ((SELECT NVL(\n" +
                        "        (SELECT ORDER_STATUSDATE FROM ERP_CUS.CUS_ORDER_STATUS_HIS \n" +
                        "        WHERE ORDER_NUMBER = A.ORDER_NUMBER AND ORDER_STATUS = 502 AND ROWNUM = 1),SYSDATE) FROM DUAL) >= A.ORDER_STATUSDATE\n" +
                        "      OR A.ORDER_STATUS = 504 OR A.ORDER_STATUS = 516 OR A.ORDER_STATUS = 517 or A.ORDER_STATUS = 503 or A.ORDER_STATUS = 501) " +
                        " AND ACTIVITI IN(?, ?)" +
                        " ORDER BY A.ORDER_STATUSDATE ASC, ORDER_STATUS";
                Query query = session.createSQLQuery(sql)
                        .addScalar("TRACKING_NO", new StringType())
                        .addScalar("WEIGHT", new LongType())
                        .addScalar("LENGTH", new LongType())
                        .addScalar("WIDTH", new LongType())
                        .addScalar("HEIGHT", new LongType())
                        .addScalar("SHIPPING_FEE", new LongType())
                        .addScalar("SERVICE_FEE", new LongType())
                        .addScalar("CURRENCY", new StringType())
                        .addScalar("OPERATE_TIME", new TimestampType())
                        .addScalar("TIME_ZONE", new StringType())
                        .addScalar("ACTION_CODE", new StringType())
                        .addScalar("REASON_CODE", new StringType())
                        .addScalar("OPERATION_DESC", new StringType())
                        .addScalar("NAME", new StringType())
                        .addScalar("PHONE", new StringType())
                        .addScalar("ADDRESS_L0", new StringType())
                        .addScalar("ADDRESS_L1", new StringType())
                        .addScalar("ADDRESS_L2", new StringType())
                        .addScalar("ADDRESS_L3", new StringType())
                        .addScalar("SITE_TYPE", new LongType())
                        .addScalar("LONGITUDE", new StringType())
                        .addScalar("LATITUDE", new StringType())
                        .addScalar("provider_order_id", new StringType())
                        .addScalar("TRACKING_ID", new LongType())
                        .addScalar("SITE_NAME", new StringType())
                        .addScalar("ORDER_STATUS", new IntegerType())
                        .addScalar("ORDER_POST_ID", new LongType())
                        .setParameter(1, orderNumber)
                        .setParameter(2, 0)
                        .setParameter(3, 2);

                List<Object[]> listData = query.list();
                List<TikTokStatusData> result = new ArrayList<>();
                TikTokStatusData cloneObject = new TikTokStatusData();
                Long cloneOrderPostId = null;
                for (Object[] objs : listData) {
                    TikTokStatusData value = new TikTokStatusData();
                    value.setTracking_no(String.valueOf(objs[0]));
                    value.setProvider_order_id(String.valueOf(objs[22]));
                    value.setTrackingId((Long) objs[23]);
                    List<Object> track_list = new ArrayList<>();
                    Map<String, Object> track_data = new HashMap<>();
                    track_data.put("weight", objs[1]);
                    track_data.put("length", objs[2]);
                    track_data.put("width", objs[3]);
                    track_data.put("height", objs[4]);
                    track_data.put("shipping_fee", objs[5]);
                    track_data.put("service_fee", objs[6]);
                    track_data.put("currency", objs[7]);
                    track_data.put("operate_time", objs[8].toString().substring(0, objs[8].toString().indexOf(".")));
                    track_data.put("time_zone", objs[9]);
                    track_data.put("action_code", objs[10]);
                    track_data.put("reason_code", objs[11]);
                    track_data.put("operation_desc", objs[12]);
                    Map<String, Object> operator = new HashMap<>();
                    operator.put("name", objs[13] == null ? "System" : objs[13]);
                    operator.put("phone", objs[14] == null ? "19008095" : objs[14]);
                    track_data.put("operator", operator);
                    Map<String, Object> cur_station = new HashMap<>();
                    cur_station.put("address_l0", objs[15]);
                    cur_station.put("address_l1", objs[16]);
                    cur_station.put("address_l2", objs[17]);
                    cur_station.put("address_l3", objs[18]);
                    if (!Utils.isNullOrEmpty(objs[19])) {
                        if ("10".compareTo(String.valueOf(objs[19])) == 0
                                || "30".compareTo(String.valueOf(objs[19])) == 0
                                || "55".compareTo(String.valueOf(objs[19])) == 0
                                || "60".compareTo(String.valueOf(objs[19])) == 0) {
                            cur_station.put("site_type", 3);
                        } else if ("40".compareTo(String.valueOf(objs[19])) == 0
                                || "80".compareTo(String.valueOf(objs[19])) == 0
                                || "90".compareTo(String.valueOf(objs[19])) == 0) {
                            cur_station.put("site_type", 2);
                        } else {
                            cur_station.put("site_type", 1);
                        }
                    }
                    cur_station.put("longitude", objs[20]);
                    cur_station.put("latitude", objs[21]);
                    cur_station.put("site_name", objs[24]);
                    Map<String, Object> pod = new HashMap<>();
                    String resultUrlImage = getUrlImageFollowOrderNumberAndStatus(session, String.valueOf(objs[0]), (Integer) objs[25], (Date) objs[8]);
                    pod.put("signature_url", resultUrlImage);
                    pod.put("proof_url", resultUrlImage);
//                    String resultCallLogUrl = getCallLogFollowOrderNumber(session, String.valueOf(objs[0]), (Date) objs[8], (Integer) objs[25]);
//                    pod.put("call_log_url", resultCallLogUrl);
                    track_data.put("pod", pod);
                    track_data.put("cur_station", cur_station);
                    Map<String, Object> pickup_courier = new HashMap<>();
                    Map<String, Object> delivery_courier = new HashMap<>();
                    if ((Integer) objs[25] == 104) {
                        CourierData pickupCourierData = getCourierData(session, String.valueOf(objs[0]), 104);
                        if (pickupCourierData != null) {
                            pickup_courier.put("name", pickupCourierData.getName());
                            pickup_courier.put("phone", pickupCourierData.getPhone());
                            track_data.put("pickup_courier", pickup_courier);
                        }
                    } else if ((Integer) objs[25] == 500L) {
                        delivery_courier.put("name", objs[13]);
                        delivery_courier.put("phone", objs[14]);
                        track_data.put("delivery_courier", delivery_courier);
                    }
                    track_list.add(track_data);
                    log.info("TRACK_DATA " + value.getTrackingId() + " - " + track_data);
                    value.setTrack_list(track_list);
                    if (objs[25].equals(400)) {
                        cloneObject.setTrackingId(value.getTrackingId());
                        cloneObject.setTracking_no(value.getTracking_no());
                        cloneObject.setProvider_order_id(value.getProvider_order_id());
                        cloneObject.setCur_station(value.getCur_station());
                        cloneObject.setTrack_list(value.getTrack_list());
                        cloneOrderPostId = (Long) objs[26];
                    }

                    if (objs[25].equals(500) && objs[26].equals(cloneOrderPostId)) {
                        ((HashMap) cloneObject.getTrack_list().get(0)).replace("action_code", "station_inbound");
                        result.add(cloneObject);
                    }

                    result.add(value);
                }
                return result;
            } catch (Exception ex) {
                log.error(ex.getLocalizedMessage(), ex);
            }
        } catch (Exception ex) {
            CommonUtils.writeErrorLogTask((new ErrorLogData(new Date(), nameProject, serverPort, Constants.errorSystem, errorTextOracle + ex.getLocalizedMessage(), ex.toString())).toString(), new Date());
            log.error(ex.getLocalizedMessage(), ex);
        } finally {
            commit(session, null);
        }
        return new ArrayList<>();
    }


    public void updateDataSentSuccessfully(Long trackingId, int status) throws Exception {
        Session session = null;
        Transaction transaction = null;
        try {
            log.info("Update status success trackingId: " + trackingId + " - " + status);
            session = sessionFactory.openSession();
            List params = new ArrayList();
            transaction = session.beginTransaction();
            NativeQuery query = session.createSQLQuery("UPDATE ERP_CUS.CUS_ORDER_STATUS_HIS SET ACTIVITI = ?"
                    + " WHERE TRACKING_ID = ?"
                    + " AND ACTIVITI IN " + (status == 1 ? "(?, ?)" : "(?)"));
            params.add(status);
            params.add(trackingId);
            if (status == 1) {
                params.add(2);
            }
            params.add(0);
            for (int i = 0; i < params.size(); i++) {
                query.setParameter(i + 1, params.get(i));
            }
            query.executeUpdate();
        } catch (Exception ex) {
            CommonUtils.writeErrorLogTask((new ErrorLogData(new Date(), nameProject, serverPort, Constants.errorSystem, errorTextOracle + ex.getLocalizedMessage(), ex.toString())).toString(), new Date());
            log.error(ex.getLocalizedMessage(), ex);
        } finally {
            commit(session, transaction);
        }
    }


    public String getUrlImageFollowOrderNumberAndStatus(Session session, String orderNumber, Integer status, Date currentDate) throws Exception {
        Long convertStatus = null;
        if (status == 102) {
            convertStatus = Long.valueOf(102);
        } else if (status == 200) {
            convertStatus = Long.valueOf(200);
        } else if (status == 400) {
            convertStatus = Long.valueOf(400);
        } else if (status == 500) {
            convertStatus = Long.valueOf(0);
        } else if (status == 501) {
            convertStatus = Long.valueOf(1);
        } else if (status == 502) {
            convertStatus = Long.valueOf(2);
        } else if (status == 504) {
            convertStatus = Long.valueOf(4);
        } else if (status == 506) {
            convertStatus = Long.valueOf(6);
        }
        String newCurrentDate = convertDateMongo(currentDate.toString());
        try {

            Date maxDateDelivery = (Date) session.createSQLQuery("SELECT MAX(ORDER_STATUSDATE) AS ORDER_STATUSDATE FROM ERP_CUS.CUS_ORDER_STATUS_HIS WHERE ORDER_NUMBER = ? AND ORDER_STATUSDATE < ?  AND ORDER_STATUS != 202")
                    .setParameter(1, orderNumber)
                    .setParameter(2, currentDate)
                    .addScalar("ORDER_STATUSDATE", new TimestampType()).uniqueResult();
            if (maxDateDelivery != null) {
                String newMaxDateDelivery = convertDateMongo(maxDateDelivery.toString());
                try {
                    org.springframework.data.mongodb.core.query.Query query = new org.springframework.data.mongodb.core.query.Query();
                    query.addCriteria(Criteria.where("ma_phieugui").is(orderNumber));
                    query.addCriteria(Criteria.where("trang_thai").is(convertStatus));
                    query.addCriteria(Criteria.where("time_created").gte(newMaxDateDelivery + ".0").lt(newCurrentDate + ".0"));

                    List<ImageStoreForm> lst = _template.find(query, ImageStoreForm.class);
                    if (lst.size() > 0) {
                        List<String> listImage = new ArrayList<>();
                        for (ImageStoreForm dataOut : lst) {
                            listImage.add(dataOut.getImg_link());
                        }
                        String listImageConvert1 = (listImage.toString()).replace("[", "");
                        return ((listImageConvert1.replace("]", "")).replace(" ", ""));
                    } else {
                        return null;
                    }

                } catch (Exception ex) {
                    throw ex;
                }
            } else {
                return null;
            }

        } catch (Exception ex) {
            throw ex;
        }
    }

    public String getCallLogFollowOrderNumber(Session session, String orderNumber, Date currentDate, Integer status) throws Exception {
        Long type = -9999L;
        if (status <= 200) {
            type = 3L;
        } else if (status >= 500) {
            type = 2L;
        }
        try {

            Date maxDateDelivery = (Date) session.createSQLQuery("SELECT MAX(ORDER_STATUSDATE) AS ORDER_STATUSDATE FROM ERP_CUS.CUS_ORDER_STATUS_HIS WHERE ORDER_NUMBER = ? AND ORDER_STATUSDATE < ?")
                    .setParameter(1, orderNumber)
                    .setParameter(2, currentDate)
                    .addScalar("ORDER_STATUSDATE", new TimestampType()).uniqueResult();
            if (maxDateDelivery != null) {
                List<CallLogData> data = (List<CallLogData>) session.createSQLQuery("SELECT A.CALL_TYPE, A.CALL_STATUS , A.PHONE, A.CALL_DATE, A.CALL_DURATION FROM VTP_CALL_LOG A WHERE ORDER_NUMBER = ? AND CALL_TYPE = ? AND A.CALL_DATE BETWEEN ? AND ?")
                        .setParameter(1, orderNumber)
                        .setParameter(2, type)
                        .setParameter(3, maxDateDelivery)
                        .setParameter(4, currentDate)
                        .addScalar("CALL_TYPE", new LongType())
                        .addScalar("CALL_STATUS", new LongType())
                        .addScalar("PHONE", new StringType())
                        .addScalar("CALL_DATE", new StringType())
                        .addScalar("CALL_DURATION", new LongType())
                        .setResultTransformer(Transformers.aliasToBean(CallLogData.class)).list();
//                List<String> dataLog = new ArrayList<>();
//                for (CallLogData dataOut : data) {
//                    dataLog.add("Type " + dataOut.getCALL_TYPE() + " Status " + dataOut.getCALL_STATUS() + " " + dataOut.getPHONE() + " " + dataOut.getCALL_DATE() + "(" + dataOut.getCALL_DURATION() + ")");
//                }
//                String dataConvert = (dataLog.toString()).replace("[", "");
//                return (dataConvert.replace("]", ""));
//                if (data.size() > 0L) {
//                    String fromDate = String.valueOf(maxDateDelivery.getTime());
//                    String toDate = String.valueOf(currentDate.getTime());
//                    return urlCallLog + "orderNumber=" + orderNumber + "&" + "fromDate=" + fromDate + "&" + "toDate=" + toDate + "&" + "status=" + status;
//                } else {
//                    return null;
//                }
            }
            return null;

        } catch (Exception ex) {
            log.error(ex.getLocalizedMessage(), ex);
        }

        return null;
    }

    private String convertDateMongo(String dateConvert) throws ParseException {
        DateFormat inputDate = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        DateFormat outputDate = new SimpleDateFormat("dd/MM/yyyy HH:mm:ss");
        Date date = inputDate.parse(dateConvert);
        return outputDate.format(date);
    }

    public CourierData getCourierData(Session session, String orderNumber, Integer status) throws Exception {
        if (status == 104L || status == 500L) {
            try {
                if (status == 104) {
                    CourierData pickupCourierData = (CourierData) session.createSQLQuery("select * from(" +
                                    " select FIRSTNAME ||' '||LASTNAME AS NAME, TELEPHONE AS PHONE from nhan_buugui a, susers b where a.ma_vandon = ? and a.buu_ta_nhan = b.userid" +
                                    " union all \n" +
                                    " select FIRSTNAME ||' '||LASTNAME AS NAME, TELEPHONE AS PHONE from G2B_SC_VANDON_DH a, susers b where a.ma_vandon = ? and a.buuta_nhan is not null and a.buuta_nhan > 0 and a.buuta_nhan = b.userid" +
                                    ") where rownum = 1")
                            .setParameter(1, orderNumber)
                            .setParameter(2, orderNumber)
                            .addScalar("name", new StringType())
                            .addScalar("phone", new StringType())
                            .setResultTransformer(Transformers.aliasToBean(CourierData.class)).uniqueResult();
                    return pickupCourierData;
                }
            } catch (Exception ex) {
                log.error(ex.getLocalizedMessage(), ex);
            }
        }
        return null;
    }
}
